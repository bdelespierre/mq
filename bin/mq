#!/usr/bin/env bash
#
# mq - MySQL/MariaDB client wrapper with argument expansion and SQL shorthand
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
GRC_CONF="$PROJECT_ROOT/share/grc/conf.mq"

source "$PROJECT_ROOT/lib/mq/transform.bash"
source "$PROJECT_ROOT/lib/mq/format.bash"

VERSION="1.5.0"

declare -a MYSQL_OPTIONS=()
FORMAT="table"
QUIET=0
DRY_RUN=0
INPUT_FILE=""
DEBUG="${DEBUG:-0}"
COLOR="auto"  # auto, always, never
FORMAT_FILTER="cat"
MQ_QUERIES_DIR="${MQ_QUERIES_DIR:-$HOME/.local/share/mq/queries}"
SAVE_BOOKMARK=""

# Default format: table for TTY, tsv for pipes
if [[ ! -t 1 ]]; then
    FORMAT="tsv"
fi

debug() {
    [[ "$DEBUG" == "1" ]] && >&2 echo -e "\e[33m[debug]\e[0m $*"
    return 0
}

warn() {
    [[ "$QUIET" == "1" ]] && return 0
    >&2 echo -e "\e[33m$*\e[0m"
}

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [--] [ARGUMENT]... [+]

MySQL/MariaDB client wrapper with argument expansion and SQL shorthand helpers.
When last argument is +, display query result vertically (equivalent of \G).

Options:
    -h, --help                 Show this help message and exit
    -v, --version              Show version and exit
    -o, --option NAME[=VALUE]  Set MySQL/MariaDB client option (see mysql --help)
    -f, --format NAME          Output format: table, vertical, html, xml, csv, json, or tsv
                               Default: table (TTY) or tsv (pipe)
    -q, --quiet                Suppress query echo to stderr
    -n, --dry-run              Show query without executing
    -i, --input FILE           Read query from file (use - for stdin)
        --color[=WHEN]         Colorize output (requires grcat): auto, always, never
                               Default: auto (color when stdout is a TTY)

Arguments:
    :VALUE             Shorthand for %string VALUE
    %s, %string VALUE  Treat value as a string
    %j, %json VALUE    Treat value as a JSON path

    %a, %all           Alias of *
    %c, %count         Alias of COUNT(*)
    %r, %rand          Alias of RAND()
        %now           Alias of NOW()
        %sum COLUMN    Alias of SUM(COLUMN)
        %avg COLUMN    Alias of AVG(COLUMN)
        %min COLUMN    Alias of MIN(COLUMN)
        %max COLUMN    Alias of MAX(COLUMN)
        %eq            Alias of =
        %ne            Alias of <> or !=
        %gt            Alias of >
        %gte           Alias of >=
        %lt            Alias of <
        %lte           Alias of <=
        %between LO HI Alias of BETWEEN 'LO' AND 'HI'
        %in VALUES     Alias of IN (VALUES)

Bookmarks:
        --save NAME            Save query as a named bookmark
        --run NAME             Run a saved bookmark
        --list                 List saved bookmarks
        --show NAME            Show a saved bookmark's SQL
        --delete NAME          Delete a saved bookmark

    Bookmarks are stored in ~/.local/share/mq/queries/ (override with MQ_QUERIES_DIR).
    Names may contain letters, digits, hyphens, and underscores.

Examples:
    $(basename "$0") -o database=mydb select %count from users where birthdate %gt :2000-01-01
    $(basename "$0") --save active-users -n select %count from users where status=:active
    $(basename "$0") --run active-users
    PAGER=less $(basename "$0") select %a from users where email=:john.doe@example.com +

Configuration:
    Options are loaded from (in order, later overrides earlier):
        1. ~/.mqrc                     Global defaults
        2. ./.mqrc                     Project-local overrides
           ./.mqrc.dist                (fallback if .mqrc missing)

    Config files are sourced as bash:
        MYSQL_OPTIONS+=(
            --host=localhost
            --database=mydb
        )
        FORMAT=table
        QUIET=1

    Use a MySQL defaults file for credentials:
        MYSQL_OPTIONS+=(--defaults-file=~/.my.cnf)
        MYSQL_OPTIONS+=(--defaults-extra-file=.my.cnf)

    Override global config location with MQRC environment variable.

EOF
}

load_config() {
    local config_file="${MQRC:-$HOME/.mqrc}"

    if [[ -f "$config_file" ]]; then
        debug "Loading global config: $config_file"

        # shellcheck disable=SC1090
        source "$config_file"
    else
        debug "Global config not found: $config_file"
    fi

    local local_config=""
    if [[ -f ".mqrc" ]]; then
        local_config=".mqrc"
    elif [[ -f ".mqrc.dist" ]]; then
        local_config=".mqrc.dist"
    fi

    if [[ -n "$local_config" ]]; then
        debug "Loading local config: $PWD/$local_config"

        # shellcheck disable=SC1090
        source "$local_config"
    else
        debug "No local config found (.mqrc or .mqrc.dist)"
    fi
}

set_format() {
    debug "Applying format: $FORMAT"

    case "$FORMAT" in
        table)    set_mysql_option "table" ;;
        vertical) set_mysql_option "vertical" ;;
        html)     set_mysql_option "html" ;;
        xml)      set_mysql_option "xml" ;;
        tsv)      set_mysql_option "silent" ;;
        csv)
            set_mysql_option "batch"
            FORMAT_FILTER="tsv_to_csv"
            ;;
        json)
            set_mysql_option "batch"
            FORMAT_FILTER="tsv_to_json"
            ;;
        *)
            >&2 echo "Invalid format: $FORMAT"
            exit 1
            ;;
    esac
}

set_mysql_option() {
    local opt="$1"

    if [[ "$opt" =~ ^[^=]{2} ]]; then
        MYSQL_OPTIONS+=("--$opt")
    else
        MYSQL_OPTIONS+=("-$opt")
    fi
}

should_color() {
    case "$COLOR" in
        always) return 0 ;;
        never)  return 1 ;;
        auto)   [[ -t 1 ]]; return ;;
        *)
            >&2 echo "Invalid --color value: $COLOR (must be auto, always, or never)"
            exit 1
            ;;
    esac
}

grc_available() {
    if ! command -v grcat &>/dev/null; then
        warn "grcat not found; install grc for colorized output"
        return 1
    fi

    if [[ ! -f "$GRC_CONF" ]]; then
        warn "grc config not found: $GRC_CONF"
        return 1
    fi
}

set_pager() {
    if [[ -n "${PAGER:-}" ]]; then
        PAGER_CMD="$PAGER"
    elif should_color && grc_available; then
        PAGER_CMD="grcat $GRC_CONF"
    else
        PAGER_CMD="cat"
    fi

    debug "PAGER: $PAGER_CMD"
}

execute_query() {
    local sql="$1"

    debug "SQL: $sql"
    debug "MySQL options: ${MYSQL_OPTIONS[*]}"

    if [[ $DRY_RUN -eq 1 ]]; then
        debug "Dry-run mode: printing query without executing"
        echo "$sql"
        return 0
    fi

    if [[ $QUIET -eq 0 ]]; then
        >&2 echo -e "> \e[2m$sql\e[0m"
    fi

    debug "Executing: mysql ${MYSQL_OPTIONS[*]}"
    mysql "${MYSQL_OPTIONS[@]}" <<< "$sql" | $FORMAT_FILTER | $PAGER_CMD
}

validate_bookmark_name() {
    local name="$1"
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        >&2 echo "Invalid bookmark name: $name (only letters, digits, - and _ allowed)"
        exit 1
    fi
}

save_bookmark() {
    local name="$1" sql="$2"
    validate_bookmark_name "$name"
    mkdir -p "$MQ_QUERIES_DIR"
    printf '%s\n' "$sql" > "$MQ_QUERIES_DIR/$name.sql"
    >&2 echo "Saved bookmark '$name'"
}

list_bookmarks() {
    if [[ ! -d "$MQ_QUERIES_DIR" ]]; then
        return 0
    fi
    local f
    for f in "$MQ_QUERIES_DIR"/*.sql; do
        [[ -f "$f" ]] || continue
        basename "$f" .sql
    done
}

show_bookmark() {
    local name="$1"
    validate_bookmark_name "$name"
    local file="$MQ_QUERIES_DIR/$name.sql"
    if [[ ! -f "$file" ]]; then
        >&2 echo "Bookmark not found: $name"
        exit 1
    fi
    cat "$file"
}

delete_bookmark() {
    local name="$1"
    validate_bookmark_name "$name"
    local file="$MQ_QUERIES_DIR/$name.sql"
    if [[ ! -f "$file" ]]; then
        >&2 echo "Bookmark not found: $name"
        exit 1
    fi
    rm "$file"
    >&2 echo "Deleted bookmark '$name'"
}

main() {
    debug "mq version $VERSION"
    debug "TTY detected: $([[ -t 1 ]] && echo "yes" || echo "no")"
    debug "Default format: $FORMAT"

    load_config

    local opts
    if ! opts=$(getopt -o hvo:f:qni: --long help,version,option:,format:,quiet,dry-run,input:,color::,save:,run:,list,show:,delete: -n "$(basename "$0")" -- "$@"); then
        >&2 usage
        exit 1
    fi
    eval set -- "$opts"

    while true; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -v|--version)
                echo "mq $VERSION"
                exit 0
                ;;
            -o|--option)
                debug "Option: -o $2"
                set_mysql_option "$2"
                shift 2
                ;;
            -f|--format)
                debug "Option: -f $2"
                FORMAT="$2"
                shift 2
                ;;
            -q|--quiet)
                debug "Option: -q (quiet mode)"
                QUIET=1
                shift
                ;;
            -n|--dry-run)
                debug "Option: -n (dry-run mode)"
                DRY_RUN=1
                shift
                ;;
            -i|--input)
                debug "Option: -i $2"
                INPUT_FILE="$2"
                shift 2
                ;;
            --color)
                debug "Option: --color=$COLOR"
                COLOR="${2:-always}"
                shift 2
                ;;
            --save)
                debug "Option: --save $2"
                SAVE_BOOKMARK="$2"
                shift 2
                ;;
            --run)
                debug "Option: --run $2"
                validate_bookmark_name "$2"
                INPUT_FILE="$MQ_QUERIES_DIR/$2.sql"
                shift 2
                ;;
            --list)
                list_bookmarks
                exit 0
                ;;
            --show)
                show_bookmark "$2"
                exit 0
                ;;
            --delete)
                delete_bookmark "$2"
                exit 0
                ;;
            --)
                shift
                break
                ;;
            *)
                >&2 echo "Unexpected option: $1"
                exit 1
                ;;
        esac
    done

    debug "Final options: FORMAT=$FORMAT QUIET=$QUIET DRY_RUN=$DRY_RUN INPUT_FILE=$INPUT_FILE"

    local sql="" vertical_requested=""

    if [[ -n "$INPUT_FILE" ]]; then
        if [[ "$INPUT_FILE" == "-" ]]; then
            debug "Reading from stdin"
            sql=$(cat)
        elif [[ -f "$INPUT_FILE" ]]; then
            debug "Reading query from input file: $INPUT_FILE"
            sql=$(cat "$INPUT_FILE")
        else
            >&2 echo "File not found: $INPUT_FILE"
            exit 1
        fi
        debug "Query from file: $sql"
    else
        if [[ $# -eq 0 ]]; then
            >&2 echo "No query specified"
            >&2 usage
            exit 1
        fi

        debug "Query arguments: $*"

        build_query sql vertical_requested "$@"

        debug "Built query: $sql"
        debug "Vertical requested: $vertical_requested"

        [[ "$vertical_requested" == 1 ]] && FORMAT="vertical"
    fi

    if [[ -n "$SAVE_BOOKMARK" ]]; then
        save_bookmark "$SAVE_BOOKMARK" "$sql"
    fi

    set_format
    set_pager
    execute_query "$sql"
}

main "$@"
