#!/usr/bin/env bash
#
# mysql-query - MySQL client wrapper with argument expansion and SQL shorthand
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source library functions
source "$PROJECT_ROOT/lib/mysql-query/transform.sh"

# Version
VERSION="1.0.0"

# Global options
declare -a MYSQL_OPTIONS=()
FORMAT="tsv"
QUIET=0
DRY_RUN=0
INPUT_FILE=""

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [--] [ARGUMENT]... [+]

MySQL client wrapper with argument expansion and SQL shorthand helpers.
When last argument is +, display query result vertically (equivalent of \G).

Options:
    -h, --help                 Show this help message and exit
    -v, --version              Show version and exit
    -o, --option NAME[=VALUE]  Set MySQL client option (see mysql --help)
    -f, --format NAME          Output format: table, vertical, html, xml, or tsv (default)
    -q, --quiet                Suppress query echo to stderr
    -n, --dry-run              Show query without executing
    -i, --input FILE           Read query from file (use - for stdin)

Arguments:
    :VALUE             Shorthand for %string VALUE
    %s, %string VALUE  Treat value as a string
    %j, %json VALUE    Treat value as a JSON path

    %a, %all           Alias of *
    %c, %count         Alias of COUNT(*)
    %r, %rand          Alias of RAND()
        %now           Alias of NOW()
        %eq            Alias of =
        %ne            Alias of <> or !=
        %gt            Alias of >
        %gte           Alias of >=
        %lt            Alias of <
        %lte           Alias of <=
        %in VALUES     Alias of IN (VALUES)

Examples:
    $(basename "$0") -o database=mydb select %count from users where birthdate %gt :2000-01-01
    PAGER=less $(basename "$0") select %a from users where email=:john.doe@example.com +

Configuration:
    Options are loaded from (in order, later overrides earlier):
        1. ~/.mysql-queryrc           Global defaults
        2. ./.mysql-queryrc           Project-local overrides
           ./.mysql-queryrc.dist      (fallback if .mysql-queryrc missing)

    Config files are sourced as bash:
        MYSQL_OPTIONS+=(
            --host=localhost
            --database=mydb
        )
        FORMAT=table
        QUIET=1

    Override global config location with MYSQL_QUERYRC environment variable.

EOF
}

# Load configuration from ~/.mysql-queryrc and ./.mysql-queryrc
load_config() {
    local config_file="${MYSQL_QUERYRC:-$HOME/.mysql-queryrc}"

    # Global config
    if [[ -f "$config_file" ]]; then
        [[ $QUIET -eq 0 ]] && >&2 echo -e "Loading \e[2m$config_file\e[0m"
        # shellcheck disable=SC1090
        source "$config_file"
    fi

    # Project-local config (overrides/augments global)
    local local_config=""
    if [[ -f ".mysql-queryrc" ]]; then
        local_config=".mysql-queryrc"
    elif [[ -f ".mysql-queryrc.dist" ]]; then
        local_config=".mysql-queryrc.dist"
    fi

    if [[ -n "$local_config" ]]; then
        [[ $QUIET -eq 0 ]] && >&2 echo -e "Loading \e[2m$PWD/$local_config\e[0m"
        # shellcheck disable=SC1090
        source "$local_config"
    fi
}

# Apply format to MySQL options array
apply_format() {
    case "$FORMAT" in
        table)    MYSQL_OPTIONS+=("--table") ;;
        vertical) MYSQL_OPTIONS+=("--vertical") ;;
        html)     MYSQL_OPTIONS+=("--html") ;;
        xml)      MYSQL_OPTIONS+=("--xml") ;;
        tsv)      MYSQL_OPTIONS+=("--silent") ;;
        *)
            >&2 echo "Invalid format: $FORMAT"
            return 1
            ;;
    esac
}

# Execute the query
execute_query() {
    local sql="$1"

    # Dry-run mode: print query and exit
    if [[ $DRY_RUN -eq 1 ]]; then
        echo "$sql"
        return 0
    fi

    # Print the query to stderr (dimmed) unless quiet mode
    if [[ $QUIET -eq 0 ]]; then
        >&2 echo -e "> \e[2m$sql\e[0m"
    fi

    # Execute and pipe through pager
    mysql "${MYSQL_OPTIONS[@]}" <<< "$sql" | ${PAGER:-cat}
}

main() {
    # Pre-scan for quiet flag (needed before config loading)
    for arg in "$@"; do
        [[ "$arg" == "-q" || "$arg" == "--quiet" ]] && QUIET=1
    done

    # Load config file defaults (can be overridden by CLI options)
    load_config

    # Parse options with getopt
    local opts
    if ! opts=$(getopt -o hvo:f:qni: --long help,version,option:,format:,quiet,dry-run,input: -n "$(basename "$0")" -- "$@"); then
        >&2 usage
        exit 1
    fi
    eval set -- "$opts"

    while true; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -v|--version)
                echo "mysql-query $VERSION"
                exit 0
                ;;
            -o|--option)
                # Handle MySQL options (convert to --name or -n format)
                if [[ "$2" =~ ^[^=]{2} ]]; then
                    MYSQL_OPTIONS+=("--$2")
                else
                    MYSQL_OPTIONS+=("-$2")
                fi
                shift 2
                ;;
            -f|--format)
                FORMAT="$2"
                shift 2
                ;;
            -q|--quiet)
                QUIET=1
                shift
                ;;
            -n|--dry-run)
                DRY_RUN=1
                shift
                ;;
            -i|--input)
                INPUT_FILE="$2"
                shift 2
                ;;
            --)
                shift
                break
                ;;
            *)
                >&2 echo "Unexpected option: $1"
                exit 1
                ;;
        esac
    done

    # Apply the selected format
    apply_format || exit 1

    local sql=""

    # Read query from input file or stdin
    if [[ -n "$INPUT_FILE" ]]; then
        if [[ "$INPUT_FILE" == "-" ]]; then
            sql=$(cat)
        elif [[ -f "$INPUT_FILE" ]]; then
            sql=$(cat "$INPUT_FILE")
        else
            >&2 echo "File not found: $INPUT_FILE"
            exit 1
        fi
    else
        # Check for query arguments
        if [[ $# -eq 0 ]]; then
            >&2 echo "No query specified"
            >&2 usage
            exit 1
        fi

        # Build the query from arguments
        local vertical_requested=""
        build_query sql vertical_requested "$@"

        [[ "$vertical_requested" == 1 ]] && MYSQL_OPTIONS+=("--vertical")
    fi

    # Execute the query
    execute_query "$sql"
}

main "$@"
